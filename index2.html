<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>白花油活動（現金價）計算＋訂單圖檔</title>
  <style>
    :root {
      --border: #ccc;
      --muted: #666;
      --gift: #0a7c2f;
      --card: #ffffff;
      --accent: #0b72ff;
    }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; padding: 10px; background:#fff; }
    h2 { margin: 8px 0 14px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    input[type="number"], input[type="text"] { padding: 6px 8px; font-size: 1rem; }
    .row { display:flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 8px 0; }
    .order-card {
      width: 880px; background: var(--card); color:#000; border: 1px solid var(--border);
      border-radius: 12px; padding: 18px; box-shadow: 0 6px 24px rgba(0,0,0,.06);
    }
    .order-head { display:flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .order-title { font-size: 20px; font-weight: 800; }
    .order-meta { font-size: 14px; color: #333; display:flex; gap: 16px; flex-wrap: wrap; }
    .order-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; table-layout: fixed; }
    .order-table th, .order-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: right; word-wrap: break-word; }
    .order-table th:first-child, .order-table td:first-child { text-align: left; }
    .order-summary { margin-top: 10px; display: grid; grid-template-columns: 1fr auto; gap: 6px; font-size: 14px; }
    .order-summary .label { color: #333; }
    .order-summary .value { font-weight: 800; }
    .order-gift { margin-top: 8px; font-weight: 700; color: var(--gift); }
    .divider { height: 1px; background:#e8e8e8; margin: 8px 0; }
    button { padding: 10px 12px; font-size: 1rem; cursor: pointer; border-radius: 10px; border: 1px solid var(--border); background: white; }
    button.primary { background: var(--accent); color:#fff; border-color: var(--accent); }
    .sticky-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background:#fff; border-top:1px solid var(--border);
      padding:10px; box-shadow:0 -2px 5px rgba(0,0,0,0.08); z-index:1000;
      display:flex; flex-direction:column; gap:6px;
    }
    .sticky-row { display:flex; justify-content:space-between; align-items:center; font-size: 14px; }
    .gift-em { color: var(--gift); font-weight: 800; }
    @media (max-width: 600px) {
      .order-card { width: 100%; padding: 12px; }
      body { padding-bottom: 160px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h2>白花油活動（現金價）計算</h2>

  <!-- 基本輸入 -->
  <div class="row">
    <label>客戶名稱：<input type="text" id="customer" placeholder="例如：王小明藥局"></label>
    <label>備註：<input type="text" id="note" placeholder="例如：急件／星期四到貨"></label>
    <label>之前已出金額：<input type="number" id="previous-total" value="0" min="0" inputmode="numeric" pattern="[0-9]*"></label>
  </div>

  <table>
    <thead>
      <tr><th>品名</th><th>現金價</th><th>數量</th><th>小計</th></tr>
    </thead>
    <tbody id="product-table">
      <tr><td>白花油 #1</td><td>240</td><td><input type="number" min="0" value="0" data-price="240"></td><td class="subtotal">0</td></tr>
      <tr><td>白花油 #2</td><td>154</td><td><input type="number" min="0" value="0" data-price="154"></td><td class="subtotal">0</td></tr>
      <tr><td>白花油 #3</td><td>89</td><td><input type="number" min="0" value="0" data-price="89"></td><td class="subtotal">0</td></tr>
      <tr><td>白花油 XL</td><td>432</td><td><input type="number" min="0" value="0" data-price="432"></td><td class="subtotal">0</td></tr>
    </tbody>
  </table>

  <!-- 訂單卡片（輸出圖檔用） -->
  <div id="order-card" class="order-card" style="margin-top:14px;">
    <div class="order-head">
      <div class="order-title">訂單確認單</div>
      <div class="order-meta"><span id="meta-date"></span></div>
    </div>
    <div class="order-meta">
      <div>客戶：<span id="meta-customer">—</span></div>
      <div>備註：<span id="meta-note">—</span></div>
    </div>
    <div class="divider"></div>
    <table class="order-table">
      <thead><tr><th>品名</th><th>數量</th><th>單價</th><th>小計</th></tr></thead>
      <tbody id="order-items"><tr><td colspan="4" style="text-align:center;color:#666;">尚未選購任何品項</td></tr></tbody>
    </table>
    <div class="order-summary">
      <div class="label">本次總計：</div><div class="value" id="sum-grand">0 元</div>
      <div class="label">之前已出：</div><div class="value" id="sum-prev">0 元</div>
      <div class="label">加總金額：</div><div class="value" id="sum-final">0 元</div>
    </div>
    <div class="order-gift" id="sum-gift">滿額贈品：無</div>
  </div>

  <!-- 手機底部固定資訊 -->
  <div class="sticky-bar">
    <div class="sticky-row">總計金額（含已出）：<span id="grand-total">0</span> 元</div>
    <div class="sticky-row"><span class="gift-em" id="gift-info">滿額贈品：無</span></div>
    <div class="sticky-row" id="next-tier">距離下一支還差：— 元</div>
    <div class="row" style="gap:8px;">
      <button id="clear-btn">重新輸入</button>
      <button id="download-btn" class="primary">下載訂單圖檔</button>
    </div>
  </div>

<script>
  const inputs = document.querySelectorAll('input[type="number"][data-price]');
  const prevInput = document.getElementById('previous-total');
  const custInput = document.getElementById('customer');
  const noteInput = document.getElementById('note');

  const grandEl = document.getElementById('grand-total');
  const giftInfoEl = document.getElementById('gift-info');
  const nextTierEl = document.getElementById('next-tier');
  const clearBtn = document.getElementById('clear-btn');
  const downloadBtn = document.getElementById('download-btn');

  const orderItems = document.getElementById('order-items');
  const sumGrand = document.getElementById('sum-grand');
  const sumPrev = document.getElementById('sum-prev');
  const sumFinal = document.getElementById('sum-final');
  const sumGift = document.getElementById('sum-gift');
  const metaDate = document.getElementById('meta-date');
  const metaCustomer = document.getElementById('meta-customer');
  const metaNote = document.getElementById('meta-note');

  // 贈品規則：每 21,000 計 4 支；餘數再以每 7,000 計 1 支
  function calcGifts(total){
    const bigBlocks=Math.floor(total/21000);
    const remainder=total%21000;
    const smallBlocks=Math.floor(remainder/7000);
    return bigBlocks*4+smallBlocks;
  }
  function calcNextGap(total){
    const next7000=(Math.floor(total/7000)+1)*7000;
    return Math.max(0,next7000-total);
  }
  function currentDateStr(){
    const d=new Date(); const p=n=>n.toString().padStart(2,'0');
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }

  function updateTotals(){
    let grand = 0; // 本次
    orderItems.innerHTML='';
    inputs.forEach(input=>{
      const price = parseFloat(input.dataset.price);
      const quantity = parseInt(input.value,10) || 0;
      const subtotal = price * quantity;
      input.closest('tr').querySelector('.subtotal').textContent = subtotal;
      if(quantity>0){
        const tr=document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${input.closest('tr').children[0].textContent}</td><td>${quantity}</td><td>${price}</td><td>${subtotal}</td>`;
        orderItems.appendChild(tr);
      }
      grand += subtotal;
    });
    if(orderItems.innerHTML==='') orderItems.innerHTML='<tr><td colspan="4" style="text-align:center;color:#666;">尚未選購任何品項</td></tr>';

    const prev = parseInt(prevInput.value || '0', 10) || 0;
    const final = grand + prev;

    // 更新卡片與底部
    sumGrand.textContent = grand + ' 元';
    sumPrev.textContent = prev + ' 元';
    sumFinal.textContent = final + ' 元';
    grandEl.textContent = final;

    const gifts = calcGifts(final);
    giftInfoEl.textContent = gifts>0 ? `滿額贈品：白花油 #1 × ${gifts} 支` : '滿額贈品：無';
    sumGift.textContent = giftInfoEl.textContent;

    const gap = calcNextGap(final);
    nextTierEl.textContent = `距離下一支還差：${gap} 元`;

    metaDate.textContent = currentDateStr();
    metaCustomer.textContent = custInput.value || '—';
    metaNote.textContent = noteInput.value || '—';
  }

  async function downloadImage(){
    updateTotals();
    await new Promise(r => setTimeout(r, 50)); // 確保最新渲染
    const canvas = await html2canvas(document.getElementById('order-card'), {scale:2, backgroundColor:'#fff'});
    const dataUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl; a.download = 'order.png';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  clearBtn.addEventListener('click', ()=>{
    inputs.forEach(i=>i.value=0);
    prevInput.value = 0;
    custInput.value = '';
    noteInput.value = '';
    updateTotals();
  });

  inputs.forEach(i=>i.addEventListener('input', updateTotals));
  prevInput.addEventListener('input', updateTotals);
  custInput.addEventListener('input', updateTotals);
  noteInput.addEventListener('input', updateTotals);
  downloadBtn.addEventListener('click', downloadImage);

  updateTotals();
</script>
</body>
</html>
